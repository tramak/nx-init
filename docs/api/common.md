[Главная](../../README.md)

# Общие положения #

Клиент-серверное API системы реализовано на принципах  RESTful архитектуры. Все взаимодействие осуществляется по https протоколу.

## Формат передаваемых данных ##

Абсолютно всегда, если тело запроса/ответа не пустое - оно передается в фрмате json-строки, если не оговорено иное.

Во избежание некорректной автоматической интерпретации формата тела сообщения используемыми системами на стороне бэка и фронта, мы всегда передаем заголовок `Content-Type: application/json`. Кодировка сообщений должна быть в `utf-8`. В противном случае в документации должно быть явным образом отмечен формат передаваемых данных.

Исключение составляет ответ сервиса с кодом `204 No Content`, в таком случае заголовок можно не передавать.

Все поля передаваемыж `json` объектов имеют `camelCase` нотацию, содержат только символы латинского алфавита и цифры. Любые другие - недопустимы.

## Идентификаторы объектов ##

Если в спецификации не оговорено иное, то идентификаторами объектов должны быть строковые значения.

## Общий интерфейс ответа сервиса ##

Данные в ответе бэка возвращаются в формате:

```typescript
export namespace IResponse {
  export type Response<P, E = unknown> = ResponseSuccess<P> | ErrorResponse<E>;

  export interface ErrorResponse<E = unknown> {
    code: Codes;
    error?: string;
    messages?: Errors;
    payload?: E;
  }

  export type ResponseSuccess<P> = {
    code: Codes;
    messages?: Messages;
    payload?: P;
  }

  export enum Codes {
    // 200
    SUCCESS = '200:SUCCESS',
    // 400
    INVALID_FORMAT = '400:INVALID_FORMAT',
    REQUIRED = '400:REQUIRED',
    // 401
    AUTH = '401:NOT_AUTHORIZED',
    TOKEN_EXPIRED = '401:TOKEN_EXPIRED',
    INVALID_TOKEN = '401:INVALID_TOKEN',
    // 403
    BLOCKED = '403:RESOURCE_IS_BLOCKED',
    DENIED = '403:FORBIDDEN',
    // 404
    NOT_FOUND = '404:NOT_FOUND',
    // 500
    SERVER_ERROR = '500:SERVER_ERROR',
    // и другие...
  }

  export enum MessageType {
    ERROR = 'error',
    INFO = 'info'
  }

  export interface Message {
    type?: MessageType;
    message: string;
  }

  export interface Error extends Message {
    field?: string;
  }

  export type Messages = Array<Message>;
  export type Errors = Array<Error>;
}
```

Поля в формате ответа имеют следующие значения:

* `code` - Содержит код детализации. Эти коды утверждаются в коммуникаци между бэком и фронтом. В процессе разработки могут постоянно дополняться. Но важно сохранять стабильность значения кода, его логическое содержание и последовательность применения.
* `error` - опциональное поле, используется для передачи технических деталей ошибки (например, "sql error: ..."). Но, желательно в этом поле дать общую техническую информацию и отсылку на то где смотреть детали ошибки (например идентификатор записи в логах).
* `messages` - опциональное поле, содержит сообщение, отображаемое конечному пользователю. Это поле может быть заполнено как в случае возникновения ошибки, так и в случае успешной обработки запроса, может содержать несколько сообщений разного типа. В любом случае, если это поле содержит не пустой массив - фронтенд-приложение покажет уведомление пользователю.
* `payload` - опциональное поле, содержит полезную нагрузку - объект с данными ответа в произвольном формате. Это поле может быть заполнено не только в случае успешной обработки запроса: в случае ошибки, здесь могут передаваться дополнительные данные.


### Ответ при ошибках ввода ###

Часто будет возникать ситуация, когда на стороне сервера проваливается валидация введенных в полях значений, или с какими-то конкретными полями имеются проблемы (например, введенный логин уже существует в системе). В таком случае серверу, необходимо помимо кода детализации ошибки, вернуть информацию по полям ввода, в которых имеются проблемы.

Формат ответа реализует интерфейс:

```typescript
interface IFailedField {
    field: string;
    message: string;
}

type IFailedFieldResponse = IResponse<Array<IFailedField>>;
```

Пример ответа:

```http
HTTP/1.1 406 Not Acceptable
Content-Type: application/json

{
    "code": "406:FAILED_FIELDS",
    "messages": [
        {
            "field": "login",
            "message": "Логин уже существует в системе."
        },
        {
            "field": "class",
            "message": "Некорректный номер класса."
        }
    ]
}
```

При этом, если необходимо, дополнительно можно передать общее сообщение в поле `error`.


### Поле `code` ###

Стандартные диапазоны HTTP кодов не позволяют тщательно детализировать информацию о статусе ответа. Чаще всего, такая детализация требуется именно для случаев ошибки в обработке запроса. Такой формат обусловлен необходимостью добавить гибкость в обработку ошибок на стороне фронта. Например, код ответа 401 может поступить со стороны бэка по нескольким причинам:

* нет токена и требуется пройти аутентификацию - происходит редирект на страницу ввода логина и пароля,
* истек срок действия токена и требуется его обновление - делается автоматическая попытка обновить токен с помощью refresh-токена и повторить запрос,
* требуется ввод одноразового пароля - тогда система показывает необходимое поле ввода.

С течением времени, могут возникнуть различные ситуации, которые потребуют дополнительной детализации статуса ответа.

### Пустой ответ ###

Если, в случае успешной обработки запроса, достаточно вернуть пустой ответ - то нужно это сделать с http статусом `204 No Content`. Однако пустое тело ответа недопустимо при статусах отличных от 204-го.
